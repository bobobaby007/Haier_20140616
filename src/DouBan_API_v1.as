package  {	import flash.events.Event;	import com.adobe.serialization.json.JSON_as	import flash.net.URLRequest;	import flash.net.URLLoader;	import flash.events.EventDispatcher;	import flash.events.IOErrorEvent;	public class DouBan_API_v1 extends EventDispatcher{		static private var _api:DouBan_API_v1		static public var EVENT_GETINFO_OK:String="EVENT_GETINFO_OK"		static public var EVENT_GET_FIRSTUSERINFO_OK:String="EVENT_GET_FIRSTUSERINFO_OK"		static public var EVENT_GET_FIRST_MUSIC_OK:String="EVENT_GET_FIRST_MUSIC_OK"		static public var EVENT_GET_FIRST_BOOK_OK:String="EVENT_GET_FIRST_BOOK_OK"		static public var EVENT_GET_FIRST_MOVIE_OK:String="EVENT_GET_FIRST_MOVIE_OK"		static public var EVENT_GET_MMB_OK:String="EVENT_GET_MMB_OK"				static public var EVENT_ALL_OK:String="EVENT_ALL_OK"//				static public var _gettingArray:Array=[{currentGetting:"book_read",cat:"book",status:"read"},												//{currentGetting:"book_wish",cat:"book",status:"wish"},												//{currentGetting:"book_reading",cat:"book",status:"reading"},												//{currentGetting:"music_wish",cat:"music",status:"wish"},												{currentGetting:"music_listened",cat:"music",status:"listened"},												//{currentGetting:"music_listening",cat:"music",status:"listening"},												//{currentGetting:"movie_wish",cat:"movie",status:"wish"},												{currentGetting:"movie_watched",cat:"movie",status:"watched"}											   											   ]		static public var _currentGettingNum:int=0						public var _mainResult:Object						public var _book_ingNum:int=0		public var _book_wishNum:int=0		public var _book_edNum:int=0		public var _book_allNum:int=0				public var _music_ingNum:int=0		public var _music_wishNum:int=0		public var _music_edNum:int=0		public var _music_allNum:int=0				public var _movie_wishNum:int=0		public var _movie_edNum:int=0		public var _movie_allNum:int=0				private var _music_book_movie_in:Boolean=false		private var _group_in:Boolean=false				public var _event_allNum:int=0				public var _followerNum:int=0		public var _followingNum:int=0		public var _friend_allNum:int=0				public var _gettingId:String				public var _groupAllNum:int				private var _type:int				public var _iconImage:String		public var _userName:String				public var _firstUserName:String=""		public var _firstMusic:String=""		public var _firstBook:String=""		public var _firstMovie:String=""						public var _MMB_result:Array				public function DouBan_API_v1() {			// constructor code		}		//获得用户信息		public function _getUserInfo(){			var _urlR:URLRequest=new URLRequest(DouBan._Self._apiUrl+_gettingId+"?apikey="+DouBan._Self._apiKey)						var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,userHander)			_urlLoader.load(_urlR)		}		private function userHander(event:Event){						var _userXml:XML=XML(event.target.data)			//trace(_userXml)			var ns:Namespace=_userXml.namespace("")			//trace(_userXml.ns::link[2].@href)						_iconImage=_userXml.ns::link[2].@href			_userName=_userXml.ns::title			this.dispatchEvent(new Event(EVENT_GETINFO_OK))		}								public function _getMain(){			var _urlR:URLRequest=new URLRequest("http://biz.douban.com/customapi/mzone/?uid="+_gettingId+"&client_id="+DouBan._Self._apiKey)			var _ulrLoader:URLLoader=new URLLoader()			_ulrLoader.addEventListener(Event.COMPLETE,_mainHander)			_ulrLoader.load(_urlR)					}		private function _mainHander(event:Event){			trace(event.currentTarget.data)			_mainResult=JSON_as.decode(event.currentTarget.data).r			trace(_mainResult.book_tags)			//throw(_mainResult.first_following)			_followerNum=_mainResult.follower_num			_followingNum=_mainResult.following_num			_friend_allNum=_followerNum+_followingNum									//_getFirstUserInfo(_mainResult.first_following)			//getFirstMusic(_mainResult.first_music_id)			//getFirstBook(_mainResult.first_book_id)			//getFirstMovie(_mainResult.first_movie_id)						_getAll()					}		public function _getAll(){			_getCollection(_gettingArray[_currentGettingNum].cat,_gettingArray[_currentGettingNum].status)			_getGroupNum()		}		//第一个关注用户信息		public function _getFirstUserInfo(__userId:String){			if(__userId==null||__userId==""){				return			}			var _urlR:URLRequest=new URLRequest(DouBan._Self._apiUrl+__userId+"?apikey="+DouBan._Self._apiKey)						var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,firstUserHander)			_urlLoader.addEventListener(IOErrorEvent.IO_ERROR,ioErrorHander)			_urlLoader.load(_urlR)		}		private function firstUserHander(event:Event){						var _userXml:XML=XML(event.target.data)			//trace(_userXml)			var ns:Namespace=_userXml.namespace("")			//trace(_userXml.ns::link[2].@href)						//_iconImage=_userXml.ns::link[2].@href			_firstUserName=_userXml.ns::title						this.dispatchEvent(new Event(EVENT_GET_FIRSTUSERINFO_OK))		}						//----collections										private function _getCollection(__cat:String,__status:String){						/////----test				/*_music_allNum=29				_movie_allNum=34				_book_allNum=12								_groupAllNum=6								this.dispatchEvent(new Event(EVENT_ALL_OK))				return*/			//-------									var _urlR:URLRequest=new URLRequest("http://api.douban.com/people/"+_gettingId+"/collection?'start-index'='1'&'max-results'='0'&cat="+__cat+"&status="+__status+"&apikey="+DouBan._Self._apiKey)	//&cat=book		//&status=read			var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,collectionHander)			_urlLoader.load(_urlR)					}		private function collectionHander(event:Event){			//trace(event.currentTarget.data)						var _xml:XML=XML(event.currentTarget.data)						var op:Namespace=_xml.namespace("openSearch")						switch(_gettingArray[_currentGettingNum].currentGetting){				case "book_read":					_book_edNum=_xml.op::totalResults				break				case "book_wish":					_book_wishNum=_xml.op::totalResults				break				case "book_reading":					_book_ingNum=_xml.op::totalResults				break								case "music_wish":					_music_wishNum=_xml.op::totalResults				break				case "music_listened":					_music_edNum=_xml.op::totalResults				break				case "music_listening":					_music_ingNum=_xml.op::totalResults				break								case "movie_wish":					_movie_wishNum=_xml.op::totalResults				break				case "movie_watched":					_movie_edNum=_xml.op::totalResults				break			}			//trace(_xml)									_currentGettingNum+=1			if(_currentGettingNum<_gettingArray.length){				_getCollection(_gettingArray[_currentGettingNum].cat,_gettingArray[_currentGettingNum].status)			}else{									_music_allNum=_music_ingNum+_music_wishNum+_music_edNum				_movie_allNum=_movie_wishNum+_movie_edNum				_book_allNum=_book_ingNum+_book_wishNum+_book_edNum								//_event_allNum=_mainResult.event_num+_mainResult.online_num								_music_book_movie_in=true				checkIfAllIn()											}					}		//---获取参加小组数		public function _getGroupNum(){			var _urlR:URLRequest=new URLRequest("http://biz.douban.com/customapi/count_groups_by_user?uid="+_gettingId)						var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,_groupHander)			_urlLoader.load(_urlR)		}		private function _groupHander(event:Event){			var _obj:Object=JSON_as.decode(event.target.data)			_groupAllNum=_obj.r.count			_group_in=true			checkIfAllIn()		}				//------		private function checkIfAllIn(){			if(_music_book_movie_in&&_group_in){								this.dispatchEvent(new Event(EVENT_ALL_OK))			}		}		//－－－－－获得获 户 评 >=4 书影音 _MMB_result		public function _get_MMB(){			var _urlR:URLRequest=new URLRequest("http://biz.douban.com/customapi/polo_gti/subjects/?uid="+_gettingId)						var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,mmbHander)			_urlLoader.load(_urlR)		}		private function mmbHander(event:Event){			var _obj:Object=JSON_as.decode(event.target.data)						_MMB_result=_obj.result			this.dispatchEvent(new Event(EVENT_GET_MMB_OK))		}		//获取第一个音乐		private function getFirstMusic(__id:String){			if(__id==null||__id==""){				return			}			var _urlR:URLRequest=new URLRequest("http://api.douban.com/music/subject/"+__id+"?apikey="+DouBan._Self._apiKey)	//&cat=book		//&status=read			var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,firstMusicHander)			_urlLoader.addEventListener(IOErrorEvent.IO_ERROR,ioErrorHander)			_urlLoader.load(_urlR)		}		private function firstMusicHander(event:Event){			var _xml:XML=XML(event.currentTarget.data)			var ns:Namespace=_xml.namespace("")									_firstMusic=_xml.ns::title			trace("第一个音乐",_firstMusic)			this.dispatchEvent(new Event(EVENT_GET_FIRST_MUSIC_OK))		}				//获取第一本书		private function getFirstBook(__id:String){			if(__id==null||__id==""){				return			}			var _urlR:URLRequest=new URLRequest("http://api.douban.com/book/subject/"+__id+"?apikey="+DouBan._Self._apiKey)	//&cat=book		//&status=read			var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,firstBookHander)			_urlLoader.addEventListener(IOErrorEvent.IO_ERROR,ioErrorHander)			_urlLoader.load(_urlR)		}		private function firstBookHander(event:Event){			var _xml:XML=XML(event.currentTarget.data)			var ns:Namespace=_xml.namespace("")						_firstBook=_xml.ns::title			trace("第一书",_firstBook)			this.dispatchEvent(new Event(EVENT_GET_FIRST_BOOK_OK))		}		//获取第一电影		private function getFirstMovie(__id:String){			if(__id==null||__id==""){				return			}			var _urlR:URLRequest=new URLRequest("http://api.douban.com/movie/subject/"+__id+"?apikey="+DouBan._Self._apiKey)	//&cat=book		//&status=read			var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,firstMovieHander)			_urlLoader.addEventListener(IOErrorEvent.IO_ERROR,ioErrorHander)			_urlLoader.load(_urlR)		}		private function firstMovieHander(event:Event){			var _xml:XML=XML(event.currentTarget.data)			var ns:Namespace=_xml.namespace("")						_firstMovie=_xml.ns::title			trace("第一电影",_firstMovie)			this.dispatchEvent(new Event(EVENT_GET_FIRST_MOVIE_OK))		}				private function ioErrorHander(event:IOErrorEvent){			trace("--流错误--",event)			throw("--流错误--",event)		}		static public function get _self():DouBan_API_v1{			if(!_api){				_api=new DouBan_API_v1()			}			return _api		}			}	}