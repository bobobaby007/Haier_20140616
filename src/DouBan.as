package  {	import flash.events.EventDispatcher	import flash.display.MovieClip		import flash.events.Event;		import flash.net.URLLoader;	import flash.net.URLRequest;	import flash.errors.IOError;	import flash.events.IOErrorEvent;	import flash.events.ErrorEvent	import flash.net.URLRequestMethod	import flash.external.ExternalInterface		import flash.net.URLVariables		import com.adobe.serialization.json.JSON_as				import AsSaveImg.As_SaveImg		import flash.display.Bitmap;	import flash.display.BitmapData;	import flash.geom.Matrix;		public class DouBan extends MovieClip{		static public var EVENT_GETINFO_OK:String="EVENT_GETINFO_OK"		static public var EVENT_GETMUSICS_OK:String="EVENT_GETMUSICS_OK"		static public var EVENT_GETBOOKS_OK:String="EVENT_GETBOOKS_OK"		static public var EVENT_GETMOVIES_OK:String="EVENT_GETMOVIES_OK"		static public var EVENT_GETFRIEND_OK:String="EVENT_GETFRIEND_OK"		static public var EVENT_GETONLINE_INFO_OK:String="EVENT_GETONLINE_INFO_OK"										static public var STATUS_NO_LOGIN:String="STATUS_NO_LOGIN"		static public var STATUS_NO_CONTACT:String="STATUS_NO_CONTACT"		static public var STATUS_NORMAL:String="STATUS_NORMAL"				static public var EVENT_SAVEIMAGE_OK:String="EVENT_SAVEIMAGE_OK"		static public var EVENT_SAVEPNG_OK:String="EVENT_SAVEPNG_OK"		static public var EVENT_SAVEIMAGE_FAILED:String="EVENT_SAVEIMAGE_FAILED"		static public var EVENT_CONTECT_OK:String="EVENT_CONTECT_OK"		static public var EVENT_LOGIN_OK:String="EVENT_LOGIN_OK"		static public var EVENT_GET_COUNTER_OK:String="EVENT_GET_COUNTER_OK"		static public var EVENT_BROADCAST_OK:String="EVENT_BROADCAST_OK"								static private var _self:DouBan				private var _asImage:As_SaveImg				private var _isSaving:Boolean=false		private var _isSavingPng:Boolean=false				public var _saveUrl:String="http://4view.cn/interface/savefile.php"		//private var _saveUrl:String="http://www.douban.com/flash_interaction/?fi_id=jeep_2011"								public var _saveOkToUrl:String//="http://www.douban.com"		public var _loginUrl:String="http://www.douban.com/accounts/login"		public var _xmlPath:String="pics.xml"		private var _doubanlogin:String="yes"				private var _contactUrl:String="http://www.douban.com/"		private var _isContact:String="no"				private var _isMiniSite:Boolean=false		public var _miniSiteUrl:String="http://site.douban.com/haier_waterheater/"//LXGC		public var _ck:String="RJbI"		private var _bgs:String="pics/03.jpg|pics/04.jpg|pics/05.jpg|pics/07.jpg|pics/13.jpg"				public var _siteName:String="haier_waterheater"				private var _addContactUrl:String="http://www.douban.com/campaign/"				//private var _addContactUrl:String="http://www.douban.com/flash_interaction/contact/?fi_id="				//private var _likeUrl:String="http://site.douban.com/j/site/DYK/follow/"		//private var _likeUrl2:String="http://site.douban.com/j/site/DYK/like/"		private var _liked:int=0				public var _id:String="2785997"//"39434473"//"2785997"		public var _uid:String="user_uid"		public var _apiKey:String="0ed5653f4373e1792c802fbdca5ba46b"//"033c553fc6b5586b09b4ffbf54200941"//"0ed5653f4373e1792c802fbdca5ba46b"//		public var _apiUrl:String="http://api.douban.com/people/"						private var _isExpired:String="no"				public var _iconImage:String		public var _userName:String				public var _picPath:String=""//图片本身地址						public var _picUrl:String=""//图片查看链接		public var _picId:String//---图片id				public var _status_id:String=""		public var _status_url:String=""				public var _pngPath:String=""		public var _pngId:String=""				public var _booksNum:int		public var _musicsNum:int		public var _moviesNum:int				public var _friends:Array=[]				public var _CounterNum:int						public function DouBan() {			//_self=this		}		static public function get _Self():DouBan{			if(!_self){				_self=new DouBan()								//_self.setup()			}			return _self		}		public function setup(){			_saveUrl=RootParameters.getParameters("saveUrl",_saveUrl,this)			_saveOkToUrl=RootParameters.getParameters("saveOkToUrl",_saveOkToUrl,this)			_loginUrl=RootParameters.getParameters("loginUrl",_loginUrl,this)			_doubanlogin=RootParameters.getParameters("doubanlogin",_doubanlogin,this)						_xmlPath=RootParameters.getParameters("xmlPath",_xmlPath,this)			_contactUrl=RootParameters.getParameters("contactUrl",_contactUrl,this)			_isContact=RootParameters.getParameters("is_contact",_isContact,this)			_isExpired=RootParameters.getParameters("expired",_isExpired,this)			_ck=RootParameters.getParameters("ck",_ck,this)			_id=RootParameters.getParameters("user_id",_id,this)			_uid=RootParameters.getParameters("user_uid",_uid,this)			_bgs=RootParameters.getParameters("bgs",_bgs,this)				}		public function CheckStatus():String{						if(_doubanlogin.toUpperCase()=="NO"||_doubanlogin.toUpperCase()=="FALSE"||_doubanlogin.toUpperCase()=="NONE"){				return STATUS_NO_LOGIN			}			if(_isContact.toUpperCase()=="NO"||_isContact.toUpperCase()=="FALSE"||_isContact.toUpperCase()=="NONE"){					return STATUS_NO_CONTACT			}			return STATUS_NORMAL		}						//获得用户信息		public function _getUserInfo(){			var _urlR:URLRequest=new URLRequest(this._apiUrl+this._id+"?apikey="+this._apiKey)						var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,userHander)			_urlLoader.load(_urlR)		}		private function userHander(event:Event){						var _userXml:XML=XML(event.target.data)			//trace(_userXml)			var ns:Namespace=_userXml.namespace("")			//trace(_userXml.ns::link[2].@href)						_iconImage=_userXml.ns::link[2].@href			_userName=_userXml.ns::title			this.dispatchEvent(new Event(EVENT_GETINFO_OK))		}		//获取用户朋友--------		public function _getFriends(){			var _urlR:URLRequest=new URLRequest(this._apiUrl+this._id+"/contacts?apikey="+this._apiKey)						var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,friendHander)			_urlLoader.load(_urlR)		}		private function friendHander(event:Event){						var _userXml:XML=XML(event.target.data)			//trace(_userXml)			var ns:Namespace=_userXml.namespace("")			//trace(_userXml.ns::link[2].@href)			for(var i:int=0;i<_userXml.ns::entry.length();i++){				//if(_userXml.ns::entry[i].ns::link[2].@href!="http://img3.douban.com/icon/user_normal.jpg"){					_friends.push({title:_userXml.ns::entry[i].ns::title,image:_userXml.ns::entry[i].ns::link[2].@href})//---------------------------------------				//}							}			//trace(_friends[2].image)			this.dispatchEvent(new Event(EVENT_GETFRIEND_OK))		}				//--http://www.douban.com/service/apidoc/reference/collection#获取用户收藏信息		//获得用户读过书		public function _getbooks(){						var _urlR:URLRequest=new URLRequest(this._apiUrl+this._id+"/collection?'start-index'='1'&'max-results'='0'&cat=book&apikey="+this._apiKey)			//&status=read			var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,booksHander)			_urlLoader.load(_urlR)		}		private function booksHander(event:Event){						var _userXml:XML=XML(event.target.data)			//trace(_userXml)			var ns:Namespace=_userXml.namespace("openSearch")						_booksNum=int(_userXml.ns::totalResults)			//trace(_booksNum)					this.dispatchEvent(new Event(EVENT_GETBOOKS_OK))		}				//获得用户听过音乐		public function _getMusics(){						var _urlR:URLRequest=new URLRequest(this._apiUrl+this._id+"/collection?'start-index'='1'&'max-results'='0'&cat=music")			//&status=listened			var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,musicsHander)			_urlLoader.load(_urlR)		}		private function musicsHander(event:Event){						var _userXml:XML=XML(event.target.data)			//trace(_userXml)			var ns:Namespace=_userXml.namespace("openSearch")						_musicsNum=int(_userXml.ns::totalResults)			//trace(_musicsNum)					this.dispatchEvent(new Event(EVENT_GETMUSICS_OK))		}				//获得用户看过电影		public function _getMovies(){						var _urlR:URLRequest=new URLRequest(this._apiUrl+this._id+"/collection?'start-index'='1'&'max-results'='0'&cat=movie")			//&status=watched			var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,moviesHander)			_urlLoader.load(_urlR)		}		private function moviesHander(event:Event){						var _userXml:XML=XML(event.target.data)			//trace(_userXml)			var ns:Namespace=_userXml.namespace("openSearch")						_moviesNum=int(_userXml.ns::totalResults)			//trace(_moviesNum)					this.dispatchEvent(new Event(EVENT_GETMOVIES_OK))		}				public function _contectAction(){			//this.dispatchEvent(new Event(EVENT_CONTECT_OK))			//return			if(_isMiniSite){				contactAction_miniSite()			}else{				contect_normal()			}		}		public function _logAction(){						Navigate.gotoURL("http://www.douban.com/accounts/login?redir=http://site.douban.com/haier_waterheater/","_self")			//Navigate.gotoURL(_loginUrl,"_self")		}		//登陆不跳出		public function _getCkOrLog(){						var _str:String=ExternalInterface.call("get_ck_or_login")			var _object:Object=JSON_as.decode(_str)						if(_object.ck!="pending"){				_ck=_object.ck				_doubanlogin="yes"				_isContact="yes"				//_contectAction()				this.dispatchEvent(new Event(EVENT_LOGIN_OK))			}else{				ExternalInterface.addCallback("DoubanLoggedGetCK",doubanLoggedGetCK)			}		}				public function doubanLoggedGetCK(__str:String){			_getCkOrLog()		}		//----计数器		public function _counter(){			var _urlR:URLRequest=new URLRequest("http://bob.douban.com/counter/"+_siteName)			_urlR.method=URLRequestMethod.POST						var _vars:URLVariables=new URLVariables			_vars.type=0			_urlR.data=_vars									var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,PostCounterHander)			_urlLoader.load(_urlR)		}		private function PostCounterHander(event:Event){			var _str:String=event.currentTarget.data as String			trace(_str)			var _obj:Object=JSON_as.decode(_str)			//_CounterNum=_obj.r			//this.dispatchEvent(new Event(EVENT_GET_COUNTER_OK))		}		public function _getCounter(){			var _urlR:URLRequest=new URLRequest("http://bob.douban.com/counter/"+_siteName)			var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,counterHander)			_urlLoader.load(_urlR)		}		private function counterHander(event:Event){			var _str:String=event.currentTarget.data as String			//trace(_str)			var _obj:Object=JSON_as.decode(_str)			_CounterNum=_obj.r			this.dispatchEvent(new Event(EVENT_GET_COUNTER_OK))		}		//-----获得当前登陆用户		public function _getUserOnlineInfo(){			var _urlR:URLRequest=new URLRequest("http://biz.douban.com/customapi/get_user_info/")			var _urlLoader:URLLoader=new URLLoader()			_urlLoader.addEventListener(Event.COMPLETE,onlineInfoHander)			_urlLoader.load(_urlR)		}		private function onlineInfoHander(event:Event){			var _str:String=event.currentTarget.data as String			trace(_str)			var _obj:Object=JSON_as.decode(_str)			_id=String(_obj.r.userId)//"64021713"//"2785997"			_uid=String(_obj.r.userName)//"user_uid"			this.dispatchEvent(new Event(EVENT_GETONLINE_INFO_OK))					}		//---关注minisite		private function contactAction_miniSite(){						var _loader:URLLoader=new URLLoader()						var _request:URLRequest=new URLRequest(_miniSiteUrl+"connect?ck="+_ck)			_request.method=URLRequestMethod.POST			trace(_request.url)			_loader.addEventListener(Event.COMPLETE,contactHander_miniSite)			_loader.load(_request)		}		private function contactHander_miniSite(event:Event){			_isContact="yes"			this.dispatchEvent(new Event(EVENT_CONTECT_OK))		}		//---------关注普通		private function contect_normal(){			var _loader:URLLoader=new URLLoader()						var _request:URLRequest=new URLRequest(_addContactUrl+_siteName+"/contact?ck="+_ck)				_request.method=URLRequestMethod.GET						_loader.addEventListener(Event.COMPLETE,contactHander)			_loader.addEventListener(ErrorEvent.ERROR,errorHander)			_loader.addEventListener(IOErrorEvent.IO_ERROR,ioErrorHander)			trace(_request.url)			_loader.load(_request)		}		private function errorHander(event:ErrorEvent){			trace(event)		}		private function ioErrorHander(event:IOErrorEvent){			trace(event)		}		private function contactHander(event:Event){					trace("ok")			_isContact="yes"			this.dispatchEvent(new Event(EVENT_CONTECT_OK))		}					//------------豆瓣广播				public function _broadcast(__title:String,__text:String,__img:String="",__href:String=""){			var _loader:URLLoader=new URLLoader()						var _request:URLRequest=new URLRequest("http://www.douban.com/campaign/"+_siteName+"/shuo")			_request.method=URLRequestMethod.POST			var _vars:URLVariables=new URLVariables			_vars.type=0			_vars.text=__text+__href			_vars.name=__title			_vars.img=__img			_vars.ck=_ck			_vars.href=__href			_request.data=_vars						_loader.addEventListener(Event.COMPLETE,broadcastHander)			_loader.load(_request)					}		private function broadcastHander(event:Event){			var _str:String=event.target.data			var _object:Object=JSON_as.decode(_str)			try{				_status_id=_object.status_id				_status_url="http://www.douban.com/people/"+this._uid+"/status/"+_status_id+"/"			}catch(error:Error){							}			this.dispatchEvent(new Event(EVENT_BROADCAST_OK))		}		//------------------------------------------------------保存图片		public function saveImage(_array:Array=null,_width:Number=500,_height:Number=600,_description:String=""){						if(_isSaving){				return 			}									var _bitMapData:BitmapData=new BitmapData(_width,_height)			var _bitMap:Bitmap=new Bitmap(_bitMapData,"auto",true)			for(var i:int=0;i<_array.length;i++){				trace(i)				var _matrix:Matrix=new Matrix()				_matrix.tx=_array[i].x				_matrix.ty=_array[i].y				_bitMapData.draw(_array[i].object,_matrix)							}						var _bitMapM:MovieClip=new MovieClip()						_bitMapM.addChild(_bitMap)						var _imgW:Number=_width			var _imgH:Number=_height						/*			if(_imgW>600){				_imgW=600				_imgH=_height*_imgW/_width			}			_bitMap.width=_imgW			_bitMap.height=_imgH			*/						_asImage=new As_SaveImg(_imgW,_imgH)			_asImage.drawObject(_bitMapM,0,0)						if(_saveUrl.indexOf("?")!=-1){				_asImage.saveJPG(_saveUrl+"&ck="+_ck+"&description="+encodeURIComponent(_description),saveHander)			}else{				_asImage.saveJPG(_saveUrl+"?ck="+_ck+"&description="+encodeURIComponent(_description),saveHander)			}						if(_description!=""){							}else{							}						_isSaving=true		}				private function saveHander(event:Event){			_isSaving=false			trace(event.target.data)																								if(_saveOkToUrl&&_saveOkToUrl!=""){				//Navigate.gotoURL(_saveOkToUrl,"_self")			}else{				try{					var _vars:URLVariables=new URLVariables(event.target.data)					_picPath=_vars.path					_picUrl=_vars.path//"http://www.4view.cn"					_saveOkToUrl=_vars.path				}catch(error){									}			}			trace(event.target.data)																		try{								var _json:Object=JSON_as.decode(event.target.data)				_picPath=_json.photo_url	//图片本身地址				_picUrl=_json.photo_path	//图片查看链接								var _picStr:String=_json.photo_path//{"photo_url":photo_url, "photo_path":newest_pic.path(), "photo_thumb_url":photo_thumb_url}												if(_picStr.lastIndexOf("/")==_picStr.length-1){					trace("ok")					_picStr=_picStr.substr(0,_picStr.length-1)									}				_picStr=_picStr.substr(_picStr.lastIndexOf("/")+1)				trace(_picStr)								_picId=_picStr											}catch(error){				trace("json decode error:"+event.target.data)			}						if(!_picPath){				this.dispatchEvent(new Event(EVENT_SAVEIMAGE_FAILED))				return			}						ShareApi._picPath=_picPath			ShareApi._url=_picUrl						this.dispatchEvent(new Event(EVENT_SAVEIMAGE_OK))		}				//------------------------------------------------------保存临时图片		public function saveImageTo(_array:Array=null,_width:Number=500,_height:Number=600,__saveUrl:String="",__hander:Function=null){			var _bitMapData:BitmapData=new BitmapData(_width,_height)			var _bitMap:Bitmap=new Bitmap(_bitMapData,"auto",true)			for(var i:int=0;i<_array.length;i++){				var _matrix:Matrix=new Matrix()				_matrix.tx=_array[i].x				_matrix.ty=_array[i].y				_bitMapData.draw(_array[i].object,_matrix)							}						var _bitMapM:MovieClip=new MovieClip()						_bitMapM.addChild(_bitMap)						var _imgW:Number=_width			var _imgH:Number=_height						if(_imgW>600){				//_imgW=600				//_imgH=_height*_imgW/_width			}			_bitMap.width=_imgW			_bitMap.height=_imgH									_asImage=new As_SaveImg(_imgW,_imgH)			_asImage.drawObject(_bitMapM,0,0)						if(_saveUrl.indexOf("?")!=-1){				_asImage.saveJPG(__saveUrl+"&ck="+_ck,__hander)			}else{				_asImage.saveJPG(__saveUrl+"?ck="+_ck,__hander)			}		}		//----保存png图片				public function _savePngToPool(_array:Array=null,_width:Number=500,_height:Number=600){			if(_isSavingPng){				return 			}						var _bitMapData:BitmapData=new BitmapData(_width,_height)			var _bitMap:Bitmap=new Bitmap(_bitMapData,"auto",true)			for(var i:int=0;i<_array.length;i++){				trace(i)				var _matrix:Matrix=new Matrix()				_matrix.tx=_array[i].x				_matrix.ty=_array[i].y				_bitMapData.draw(_array[i].object,_matrix)							}						var _bitMapM:MovieClip=new MovieClip()						_bitMapM.addChild(_bitMap)								_asImage=new As_SaveImg(_width,_height)			_asImage.drawObject(_bitMapM,0,0)									//http://biz.douban.com/pool/submit/test/png/						//_asImage.saveJPG(_saveUrl+"?ck="+_ck,saveHander)			_asImage.saveJPG("http://battlepit.douban.com/common/store/"+this._siteName+"/jpg",savePngHander)			//_asImage.savePNG("http://biz.douban.com/pool/submit/"+this._siteName+"/png/"+"?ck="+_ck,savePngHander)						_isSavingPng=true		}				private function savePngHander(event:Event){			_isSavingPng=false			trace(event.target.data)						try{								var _json:Object=JSON_as.decode(event.target.data)								_pngPath=_json.fs_url	//图片本身地址								_pngId=_json.id							}catch(error){				trace("json decode error:"+event.target.data)				_pngPath=""				_pngId=""			}			this.dispatchEvent(new Event(EVENT_SAVEPNG_OK))		}		//--	}	}